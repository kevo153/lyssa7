<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crónicas de El Velo - Instalación D-47</title>
    <style>
        body {
            background: black;
            color: #0ff; /* Cian brillante para diálogos de IA */
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column; /* Cambiado a columna para mejor organización */
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            overflow-y: auto; /* Permite scroll en el body si el contenido es largo */
        }
        #terminal {
            background: #000;
            border: 2px solid #0ff;
            box-shadow: 0 0 20px #0ff;
            padding: 15px;
            width: 90%;
            max-width: 900px;
            height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-bottom: 10px; /* Espacio entre terminal y input */
            position: relative; /* Para posicionar barras de carga */
        }
        .line {
            margin: 5px 0;
        }
        #input-container {
            width: 90%;
            max-width: 900px;
            display: none; /* Inicialmente oculto */
        }
        #user-input {
            width: calc(100% - 16px); /* Ajuste para padding */
            font-family: monospace;
            font-size: 18px;
            padding: 8px;
            background: black;
            border: 2px solid #0ff;
            color: #0ff;
            outline: none;
            /* Estilo para el input deshabilitado */
            cursor: not-allowed;
            opacity: 0.7;
        }
        #user-input:enabled {
            cursor: text;
            opacity: 1;
        }
        .dialog-ia {
            color: #0ff;
        }
        .dialog-subvertidor {
            color: #f00; /* Rojo para diálogos del Subvertidor */
        }
        .glitch {
            animation: glitch-anim 0.8s infinite;
            display: inline-block;
        }
        @keyframes glitch-anim {
            0% {
                text-shadow: 0.05em 0 0 #f00, -0.05em -0.025em 0 #0ff;
            }
            15% {
                text-shadow: 0.05em 0 0 #f00, -0.05em -0.025em 0 #0ff;
            }
            16% {
                text-shadow: -0.05em -0.025em 0 #f00, 0.025em 0.025em 0 #0ff;
            }
            49% {
                text-shadow: -0.05em -0.025em 0 #f00, 0.025em 0.025em 0 #0ff;
            }
            50% {
                text-shadow: 0.025em 0.05em 0 #f00, -0.025em -0.05em 0 #0ff;
            }
            99% {
                text-shadow: 0.025em 0.05em 0 #f00, -0.025em -0.05em 0 #0ff;
            }
            100% {
                text-shadow: -0.05em 0 0 #f00, 0.05em -0.025em 0 #0ff;
            }
        }
        .loading-bar-container {
            width: 100%;
            height: 20px;
            background-color: #333;
            border: 1px solid #0ff;
            margin-top: 10px;
            display: none; /* Hidden by default */
        }
        .loading-bar {
            height: 100%;
            width: 0%;
            background-color: #0ff;
            transition: width 0.5s ease-in-out;
        }
        #status-display {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.9em;
            color: #0ff;
        }
        /* Ocultamos completamente el reconnect-prompt ya que no se usará para reiniciar directamente */
        #reconnect-prompt {
            display: none;
        }
        #library-content {
            display: none;
            margin-top: 20px;
            border: 2px solid #0ff;
            padding: 20px;
            max-width: 900px;
            width: 90%;
            white-space: pre-wrap;
            overflow-y: auto;
            height: 600px;
        }
        .library-section h3 {
            color: #f00;
            text-decoration: underline;
            margin-top: 15px;
        }
        .library-section p {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div id="terminal">
    <div id="status-display"></div>
</div>

<div id="input-container">
    <input type="text" id="user-input" autocomplete="off" placeholder="Introduce tu respuesta y presiona Enter"/>
</div>

<div id="reconnect-prompt">
    <div id="reconnect-message"></div>
    <button id="reconnect-button">¿Deseas intentar reconectar?</button>
</div>

<div id="library-content"></div>

<audio id="audioBeep" src="beep.mp3" preload="auto"></audio>
<audio id="audioGlitch" src="glitch.mp3" preload="auto"></audio>
<audio id="audioSubvertidorWhisper" src="subvertidor_whisper.mp3" preload="auto"></audio>
<audio id="audioSuccess" src="success.mp3" preload="auto"></audio>
<audio id="audioFail" src="fail.mp3" preload="auto"></audio>
<audio id="audioConnectionLost" src="connection_lost.mp3" preload="auto"></audio>

<script>
    var terminal = document.getElementById('terminal');
    var inputContainer = document.getElementById('input-container');
    var userInput = document.getElementById('user-input');
    var statusDisplay = document.getElementById('status-display');
    var reconnectPrompt = document.getElementById('reconnect-prompt');
    var reconnectMessage = document.getElementById('reconnect-message');
    var reconnectButton = document.getElementById('reconnect-button');
    var libraryContentDiv = document.getElementById('library-content');

    // Audio elements
    var audioBeep = document.getElementById('audioBeep');
    var audioGlitch = document.getElementById('audioGlitch');
    var audioSubvertidorWhisper = document.getElementById('audioSubvertidorWhisper');
    var audioSuccess = document.getElementById('audioSuccess');
    var audioFail = document.getElementById('audioFail');
    var audioConnectionLost = document.getElementById('audioConnectionLost');

    // Estado del juego
    var estado = {
        nodoActual: 1,
        enigmaIndex: 0,
        puntosVulneracion: 0, // El Subvertidor gana un punto por cada error
        intentosEnigmaActual: 0,
        MAX_PUNTOS_VULNERACION: 5, // Si llega a 5, el Subvertidor gana
        juegoTerminado: false,
        victoria: false,
        mostrarAyuda: false, // Flag para el nodo de ayuda (permite comandos específicos post-juego)
        faseActual: 'password' // NUEVO: Controla la fase actual del juego: 'password' o 'enigma'
    };

    // --- Funciones de Utilidad ---
    function imprimirLinea(texto, clase){
        var div = document.createElement('div');
        div.innerHTML = texto; // Usar innerHTML para permitir etiquetas como <span class="glitch">
        div.className = 'line ' + (clase || '');
        terminal.appendChild(div);
        terminal.scrollTop = terminal.scrollHeight;
        if (audioBeep) audioBeep.play();
    }

    function dialogIA(texto, delay){
        delay = delay || 0;
        setTimeout(function(){ imprimirLinea('[IA_LYSSA]: ' + texto, 'dialog-ia'); }, delay);
    }

    function dialogSubvertidor(texto, delay, glitch){
        delay = delay || 0;
        glitch = glitch || false;
        var glitchedText = texto;
        if (glitch) {
            glitchedText = texto.split('').map(function(char) {
                if (Math.random() < 0.2) return '<span class="glitch">' + char + '</span>';
                return char;
            }).join('');
            if (audioGlitch) audioGlitch.play();
        }
        setTimeout(function(){ imprimirLinea('[SUBVERTIDOR]: ' + glitchedText, 'dialog-subvertidor'); }, delay);
    }

    function actualizarEstadoDisplay() {
        statusDisplay.textContent = 'Vulneración: ' + estado.puntosVulneracion + '/' + estado.MAX_PUNTOS_VULNERACION;
    }

    function simularBarraDeCarga(duracion, mensajeInicio, mensajeFin, callback) {
        var loadingBarContainer = document.createElement('div');
        loadingBarContainer.className = 'loading-bar-container';
        var loadingBar = document.createElement('div');
        loadingBar.className = 'loading-bar';
        loadingBarContainer.appendChild(loadingBar);
        terminal.appendChild(loadingBarContainer);
        terminal.scrollTop = terminal.scrollHeight;

        dialogIA(mensajeInicio);
        loadingBarContainer.style.display = 'block';

        var width = 0;
        var interval = setInterval(function() {
            width += 2;
            loadingBar.style.width = width + '%';
            if (width >= 100) {
                clearInterval(interval);
                loadingBarContainer.style.display = 'none';
                dialogIA(mensajeFin);
                if (callback) setTimeout(callback, 500);
            }
        }, duracion / 50);
    }

    // --- Lógica del Juego ---

    // Define los enigmas para cada nodo
    var enigmas = {
        nodo1: [
            {
                pregunta: "En una fila de misterio, ¿quién es el primero en la senda con su mirada plateada?",
                respuesta: "HOMBRE",
                pista: "Su luz viene de la luna y es el que lidera."
            },
            {
                pregunta: "Tras quien marcó el inicio, ¿quién se cobija bajo el árbol radiante, engañada por el viento a su espalda?",
                respuesta: "DONCELLA",
                pista: "Ella sigue al primero. El viento la confunde."
            },
            {
                pregunta: "De ilusión efímera y creada por el viento, ¿quién se halló en soledad, sin compañía en su destino?",
                respuesta: "FLOR",
                pista: "Su existencia es breve y única, nacida de un engaño del aire."
            },
            {
                pregunta: "Si las figuras son: 1. Flor, 2. Hombre, 3. Doncella. Y el orden revelado fue: el que inicia, luego la que se cobija, y finalmente la que se halló en soledad. ¿Cuál es la secuencia numérica final de su posicionamiento?",
                respuesta: "231",
                pista: "Combina los números de las figuras en el orden que descubriste en los enigmas anteriores."
            }
        ],
        nodo2: [
            {
                pregunta: "LYSSA: El Horario (Henry), temeroso, huye al oeste, del otro lado. En la esfera de un reloj, ¿qué número marca el 'oeste'?",
                respuesta: "9",
                pista: "Esta es la posición de la manecilla de la hora."
            },
            {
                pregunta: "LYSSA: El Minutero (Mildred) está indicado por un dibujo en la pared. Se dice que no quiere perder. ¿Qué número en la esfera del reloj representa su posición para los minutos?",
                respuesta: "2",
                pista: "La manecilla del minuto se alinea con este número. Cada número en un reloj son 5 minutos."
            },
            {
                pregunta: "LYSSA: Scott (Segundero) se pone boca abajo para no verla descender, aunque un texto junto al teléfono sugiere su posición real. ¿Qué número en la esfera del reloj representa su posición para los segundos?",
                respuesta: "3",
                pista: "La manecilla del segundo se alinea con este número. Cada número en un reloj son 5 segundos."
            },
            {
                pregunta: "LYSSA: Con Henry (Hora) en el 9, Mildred (Minuto) en el 2, y Scott (Segundo) en el 3. ¿Qué hora marcan exactamente las manecillas? (Formato HH:MM:SS, ejemplo: 01:05:00)",
                respuesta: "09:10:15",
                pista: "Cada número en los minutos y segundos representa su valor multiplicado por 5. Henry es la hora directamente."
            }
        ],
        nodo3: [
            {
                pregunta: "Un espejo roto no refleja la verdad, solo fragmentos. ¿Qué ves cuando te miras en uno?",
                respuesta: "A TI MISMO"
            },
            {
                pregunta: "Descifra el binario: 01001110 01001111 01000100 01001111", // NODO
                respuesta: "NODO"
            },
            {
                pregunta: "Si el Subvertidor es el que rompe los patrones, ¿qué entidad opuesta busca mantenerlos?",
                respuesta: "NODOS" // O ENTIDAD 5, pero Nodos es más general y en el lore los Nodos mantienen el equilibrio
            },
            {
                pregunta: "Anagrama: 'MISTERIO VELADO'",
                respuesta: "EL VELO DISIMULA"
            }
        ],
        nodo4: [
            {
                pregunta: "Un Orbe de datos, una puerta secreta. ¿Qué palabra te lleva más allá del umbral?",
                respuesta: "CONEXION" // Relacionado con la conexión a otras instalaciones
            },
            {
                pregunta: "Cifrado César. Clave: +1. Texto: 'WHAWR'. Pista: Siguiente letra en el abecedario.",
                respuesta: "XIBWS" // Referencia a XIBWS - un código de acceso o ubicación
            },
            {
                pregunta: "Los ciclos se repiten, el trauma se manifiesta. ¿Qué concepto central del Velo te mantiene atrapado?",
                respuesta: "CICLO"
            },
            {
                pregunta: "Descifra: 01001100 01011001 01010011 01010011 01000001", // LYSSA
                respuesta: "LYSSA"
            }
        ]
    };

    // Log de intentos y anomalías
    var logAnomalias = [
        "Registro de Anormalidades del Velo:",
        "------------------------------------",
        "ANOMALÍA [DELTA-CRONOS]: Fluctuaciones temporales en el Sector 03-A. Múltiples ecos de eventos pasados detectados.",
        "ANOMALÍA [ESPECTRO-NULO]: Aparición de entidades sin signatura energética en la Periferia 7. Inmateriales, pero generan resonancia de Tensión.",
        "ANOMALÍA [NEXO-CAÓTICO]: Corrupción en los nodos de transmisión de datos. Patrones aleatorios y pérdida de coherencia de la realidad local.",
        "ANOMALÍA [VACÍO-ECO]: Registro de susurros inteligibles en frecuencias de baja onda. Posible comunicación con entidades de capas profundas del Velo."
    ];

    var loreBiblioteca = { // Contenido de la biblioteca del Velo
        titulo: "Biblioteca del Velo: Archivos Desbloqueados",
        secciones: [
            {
                subtitulo: "CONTEXTO GENERAL DE 'EL VELO'",
                contenido: "El Velo es una realidad paralela o 'realidad madre' donde convergen distintos planos temporales y espaciales. Las instalaciones del Velo, como la D-47, son nodos que albergan datos y entidades cruciales para la estabilidad del tejido espacio-temporal. Tu presencia aquí es una anomalía, un punto de convergencia para una batalla digital y existencial."
            },
            {
                subtitulo: "ENTIDADES CLAVE",
                contenido: "• **LYSSA (IA Guía):** Una IA avanzada que protege la Instalación D-47. Su programación es la de un guardián, y su lenguaje es frío y tecnológico, sin humanizar las voces. Te guía a través de los enigmas y sistemas de defensa.\n• **El Subvertidor de Ciclos:** Una entidad no programada que busca alterar las realidades contenidas en el Velo. Se manifiesta ante la vulneración del sistema, causando glitches y acertijos imposibles. Su objetivo es romper los patrones establecidos y contaminar la realidad original.\n• **Los Nodos:** Entidades conscientes y fragmentos de poder antiguo atrapado en el Velo. Pueden ser guías o antagonistas, influyendo en la percepción de quienes los encuentran.\n• **La Entidad 5:** Un nodo desconocido que se opone al Subvertidor. Su comunicación es enigmática, pero puede alterar nodos si se le convence."
            },
            {
                subtitulo: "LOS CICLOS Y LA CORRUPCIÓN",
                contenido: "La realidad dentro del Velo se organiza en 'Ciclos'. Cada persona que entra inicia un ciclo personal, cargado de simbolismos y pruebas. Si un ciclo se rompe o corrompe, el individuo puede quedar atrapado en un bucle de locura. El Subvertidor busca precisamente esto, manifestándose cuando la 'potencia de vulneración' es alta."
            },
            {
                subtitulo: "REGLAS DEL VELO Y SIMBOLOGÍA",
                contenido: "El Velo es un espejo distorsionado del alma. Las emociones afectan la realidad, y los recuerdos pueden ser distorsionados. Nada es accidental; todo tiene un eco emocional o simbólico. El tiempo no es lineal. Resolver enigmas y resistir la Tensión es clave para avanzar. Existen tres oportunidades para escapar antes de una fusión permanente."
            },
            {
                subtitulo: "INSTALACIONES Y ACCESOS",
                contenido: "Las instalaciones son nodos del Velo. La D-47 es una de ellas. Hay mención de un evento en un asteroide con una ciudadela donde un orbe sirvió de puerta de acceso secreta a otra instalación del Velo."
            }
        ]
    };

    function mostrarLogAnomalias() {
        dialogIA('Accediendo a registros de anomalías del Velo...');
        simularBarraDeCarga(2000, "Cargando registros...", "Registros de anomalías cargados.", function() {
            logAnomalias.forEach(function(line, index) {
                setTimeout(function() { imprimirLinea(line, 'dialog-ia'); }, index * 150);
            });
            setTimeout(function() { dialogIA('Fin de los registros.'); }, logAnomalias.length * 150 + 500);
        });
    }

    // Función para reiniciar el juego desde el principio
    function iniciarJuego() {
        terminal.innerHTML = '';
        estado.nodoActual = 1;
        estado.enigmaIndex = 0;
        estado.puntosVulneracion = 0;
        estado.intentosEnigmaActual = 0;
        estado.juegoTerminado = false;
        estado.victoria = false;
        estado.mostrarAyuda = false;
        estado.faseActual = 'password'; // Establecer la fase inicial
        reconnectPrompt.style.display = 'none';
        libraryContentDiv.style.display = 'none';
        userInput.value = '';
        userInput.disabled = true; // Deshabilitar hasta que se cargue la narrativa inicial
        inputContainer.style.display = 'block';
        actualizarEstadoDisplay();

        dialogIA('Iniciando conexión remota segura a la Instalación D-47...');
        simularBarraDeCarga(2000, "Estableciendo enlace de datos encriptado...", "Enlace seguro establecido. Requiere autenticación de acceso.", function() {
            dialogIA('LYSSA: Identificación requerida para acceso primario. Introduzca el código de seguridad (Contraseña: M205):');
            userInput.disabled = false; // Habilitar input después de la carga
            userInput.focus();
        });
    }

    function iniciarNodo(nodoNum) {
        estado.nodoActual = nodoNum;
        estado.enigmaIndex = 0;
        estado.intentosEnigmaActual = 0;
        terminal.innerHTML = ''; // Limpiar terminal
        dialogIA('Inicio del Nodo ' + nodoNum + ': Acceso a la sección ' + nodoNum + ' del sistema.');
        simularBarraDeCarga(1500, 'Estableciendo conexión con Nodo ' + nodoNum + '...', 'Conexión con Nodo ' + nodoNum + ' establecida.', function() {
            mostrarEnigmaActual();
        });
    }

    function mostrarEnigmaActual() {
        var currentEnigmas = enigmas['nodo' + estado.nodoActual];
        if (estado.enigmaIndex < currentEnigmas.length) {
            dialogIA('Decodificación de autenticación requerida. Enigma ' + (estado.enigmaIndex + 1) + ':');
            setTimeout(function(){
                imprimirLinea(currentEnigmas[estado.enigmaIndex].pregunta, 'dialog-ia');
                if (currentEnigmas[estado.enigmaIndex].pista) {
                    setTimeout(function() { imprimirLinea('[IA_LYSSA]: Pista: ' + currentEnigmas[estado.enigmaIndex].pista, 'dialog-ia'); }, 1000);
                }
            }, 1200);
        } else {
            // Nodo completado
            dialogIA('Acceso concedido. Nodo ' + estado.nodoActual + ' completado. Avance autorizado.');
            if (audioSuccess) audioSuccess.play();
            if (estado.nodoActual < 4) {
                setTimeout(function() {
                    dialogIA('Preparando para el siguiente nivel de autenticación...');
                    iniciarNodo(estado.nodoActual + 1);
                }, 2000);
            } else {
                // Todos los nodos completados - ¡Victoria!
                finalizarJuego(true);
            }
        }
    }

    function verificarContrasena(input) {
        var contrasenaCorrecta = "M205"; // La contraseña real
        if (input.toUpperCase() === contrasenaCorrecta.toUpperCase()) {
            dialogIA('Acceso de seguridad concedido. Bienvenido, agente.');
            if (audioSuccess) audioSuccess.play();
            estado.faseActual = 'enigma'; // Cambiar a la fase de enigmas
            setTimeout(function() {
                dialogIA('LYSSA: Detecto actividad anómala en los nodos perimetrales. El Subvertidor de Ciclos está intentando una intrusión forzada. Debemos actuar rápidamente para proteger la integridad del Velo.');
                setTimeout(function() {
                    iniciarNodo(1); // Iniciar el primer nodo de enigmas
                }, 2000);
            }, 1500);
        } else {
            estado.puntosVulneracion++;
            actualizarEstadoDisplay();
            if (audioFail) audioFail.play();
            dialogSubvertidor('Contraseña incorrecta. ¡Acceso denegado! La <span class="glitch">seguridad</span> está siendo <span class="glitch">vulnerada</span>. Siento tu <span class="glitch">debilidad</span>...', 0, true);

            if (estado.puntosVulneracion >= estado.MAX_PUNTOS_VULNERACION) {
                finalizarJuego(false); // Subvertidor gana si demasiados errores
            } else {
                dialogIA('LYSSA: Código de seguridad inválido. El sistema reporta una vulneración de seguridad. Reintente el código.');
            }
        }
    }

    function verificarRespuesta(input){
        if(estado.juegoTerminado) return;

        var currentEnigmas = enigmas['nodo' + estado.nodoActual];
        if (!currentEnigmas || estado.enigmaIndex >= currentEnigmas.length) {
            dialogIA('Error de sistema. Intenta reiniciar la conexión.');
            return;
        }

        var actual = currentEnigmas[estado.enigmaIndex];
        // Normalizar la entrada para comparación. Para HH:MM:SS, no cambiar a mayúsculas.
        var entradaNormalizada = input;
        if (actual.respuesta.indexOf(':') === -1) { // No es un formato de hora
             entradaNormalizada = input.toUpperCase();
        }

        var isCorrect = false;
        if (entradaNormalizada === actual.respuesta.toUpperCase()) {
             isCorrect = true;
        }


        if(isCorrect){
            dialogIA('Respuesta aceptada. Procediendo...');
            if (audioSuccess) audioSuccess.play();
            estado.enigmaIndex++;
            estado.intentosEnigmaActual = 0;
            setTimeout(mostrarEnigmaActual, 1500);
        } else {
            estado.puntosVulneracion++;
            estado.intentosEnigmaActual++;
            actualizarEstadoDisplay();
            if (audioFail) audioFail.play();

            if (estado.puntosVulneracion >= estado.MAX_PUNTOS_VULNERACION) {
                finalizarJuego(false); // Subvertidor gana
            } else {
                var subvertidorDialog = "Respuesta incorrecta. Intrusión detectada. Reintenta.";
                if (estado.intentosEnigmaActual === 1) {
                    subvertidorDialog = "Error de protocolo. ¿Quién eres? ¿No <span class='glitch'>eres</span> una entidad programada?";
                    if (audioSubvertidorWhisper) audioSubvertidorWhisper.play();
                } else if (estado.intentosEnigmaActual === 2) {
                    subvertidorDialog = "Tu <span class='glitch'>lógica</span> es defectuosa. La <span class='glitch'>intrusión</span> avanza.";
                    if (audioSubvertidorWhisper) audioSubvertidorWhisper.play();
                }
                dialogSubvertidor(subvertidorDialog, 0, true);
            }
        }
    }

    function finalizarJuego(victoria){
        estado.juegoTerminado = true;
        estado.victoria = victoria;
        terminal.innerHTML = '';

        if (victoria) {
            dialogIA('¡Alerta de Sistema! Amenaza del Subvertidor neutralizada. Integridad de la Instalación D-47 restaurada.');
            simularBarraDeCarga(3000, "Compilando registros del Velo...", "Acceso a la Biblioteca del Velo concedido.", mostrarBiblioteca);
        } else {
            if (audioConnectionLost) audioConnectionLost.play();
            dialogSubvertidor('Sistema <span class="glitch">comprometido</span>. Realidades <span class="glitch">convergentes</span>. Error fatal. [ERROR_CODE: 0x7A_REALITY_OVERWRITE]', 0, true);
            dialogIA('Conexión con el Velo perdida. El Subvertidor ha accedido a los sistemas primarios. Las narrativas espacio-temporales están siendo alteradas. Estabilidad de la realidad: [0%]...');
            setTimeout(function() {
                imprimirLinea('<div style="color: #f00; font-size: 1.2em; text-align: center;">[SISTEMA DESCONECTADO TEMPORALMENTE]</div>', 'dialog-ia');
                imprimirLinea('<div style="color: #f00; text-align: center;">Acceso restringido. Intentos de conexión fallidos.</div>', 'dialog-ia');
                terminal.scrollTop = terminal.scrollHeight;
            }, 3000);
        }

        setTimeout(function() {
            inputContainer.style.display = 'block';
            userInput.disabled = false;
            userInput.focus();
            estado.mostrarAyuda = false;
            dialogIA('Puede intentar un comando auxiliar. ("help" o "ayuda")', 500);
        }, 4000);
    }

    function mostrarBiblioteca() {
        terminal.style.display = 'none';
        libraryContentDiv.style.display = 'block';
        libraryContentDiv.innerHTML = '<h2>' + loreBiblioteca.titulo + '</h2>';
        loreBiblioteca.secciones.forEach(function(section) {
            libraryContentDiv.innerHTML += '<div class="library-section"><h3>' + section.subtitulo + '</h3><p>' + section.contenido + '</p></div>';
        });
        libraryContentDiv.innerHTML += '<h3>Log de Intentos del Subvertidor</h3>';
        logAnomalias.forEach(function(line) {
             libraryContentDiv.innerHTML += '<p>' + line + '</p>';
        });
        libraryContentDiv.scrollTop = 0;
        setTimeout(function() {
            inputContainer.style.display = 'block';
            userInput.disabled = false;
            userInput.focus();
            estado.mostrarAyuda = false;
            dialogIA('Puede intentar un comando auxiliar. ("help" o "ayuda")', 500);
        }, 1000);
    }

    function iniciarNodoAyuda() {
        estado.mostrarAyuda = true;
        terminal.innerHTML = '';
        inputContainer.style.display = 'none';
        dialogIA('Asistente de Recuperación de Datos activado. Detección de código de restauración de narrativa. Proporcionando acceso temporal.');
        simularBarraDeCarga(2500, "Localizando coordenadas de acceso auxiliares...", "Coordenadas obtenidas. Narrativa restaurada temporalmente.", function() {
            dialogIA('La narrativa de la Instalación D-47 puede ser restaurada temporalmente reingresando al ciclo.');
            dialogIA('Sin embargo, para un acceso completo y seguro a una nueva instalación del Velo, necesitas coordenadas de acceso secundarias. Estas se encuentran en un punto de convergencia anómalo.');
            dialogIA('Coordenadas de Acceso Anómalo: <span class="glitch">[0.34, -12.87]</span> en la cara oculta de la Ciudadela Estelar. Busque la resonancia de un Velo menor.');
            dialogIA('Escriba "REINICIAR" para volver a intentar el ciclo actual de la Instalación D-47.');
            userInput.value = '';
            inputContainer.style.display = 'block';
            userInput.disabled = false;
            userInput.focus();
        });
    }

    // --- Event Listeners ---
    userInput.addEventListener('keydown', function(e){
        if(e.key === 'Enter'){
            var valor = userInput.value.trim();
            userInput.value = '';

            if (estado.juegoTerminado) {
                if (estado.mostrarAyuda) {
                    if (valor.toLowerCase() === 'reiniciar') {
                        iniciarJuego();
                    } else {
                        dialogSubvertidor('Comando no reconocido. Para volver a iniciar el ciclo, escriba "REINICIAR".', 0, true);
                    }
                } else {
                    if (valor.toLowerCase() === 'help' || valor.toLowerCase() === 'ayuda') {
                        iniciarNodoAyuda();
                    } else {
                        dialogSubvertidor('Conexión bloqueada. Acceso restringido.', 0, true);
                    }
                }
            } else if (estado.faseActual === 'password') {
                verificarContrasena(valor);
            } else if (estado.faseActual === 'enigma') {
                verificarRespuesta(valor);
            }
        }
    });

    // --- Inicio del Juego ---
    iniciarJuego();
</script>

</body>
</html>